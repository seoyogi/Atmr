<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Yuta Forest 3D - Improved</title>

<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: #88c070;
    touch-action: none;
  }

  #renderCanvas {
    width: 100vw;
    height: 100vh;
    display: block;
  }

  #joystickContainer {
    position: absolute;
    left: 20px;
    bottom: 20px;
    width: 120px;
    height: 120px;
    background: rgba(0,0,0,0.2);
    border-radius: 50%;
  }

  #stick {
    position: absolute;
    left: 35px;
    top: 35px;
    width: 50px;
    height: 50px;
    background: rgba(255,255,255,0.7);
    border-radius: 50%;
  }
</style>

</head>

<body>

<canvas id="renderCanvas"></canvas>

<div id="joystickContainer">
  <div id="stick"></div>
</div>

<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

<script>

const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas, true);

let moveX = 0;
let moveY = 0;

function setupJoystick() {
  const container = document.getElementById("joystickContainer");
  const stick = document.getElementById("stick");

  let dragging = false;

  container.addEventListener("touchstart", () => dragging = true);

  container.addEventListener("touchend", () => {
    dragging = false;
    stick.style.left = "35px";
    stick.style.top = "35px";
    moveX = 0;
    moveY = 0;
  });

  container.addEventListener("touchmove", (e) => {
    if (!dragging) return;

    const rect = container.getBoundingClientRect();
    const x = e.touches[0].clientX - rect.left - 60;
    const y = e.touches[0].clientY - rect.top - 60;

    const distance = Math.min(40, Math.sqrt(x*x + y*y));
    const angle = Math.atan2(y, x);

    const dx = Math.cos(angle) * distance;
    const dy = Math.sin(angle) * distance;

    stick.style.left = 35 + dx + "px";
    stick.style.top = 35 + dy + "px";

    moveX = dx / 40;
    moveY = dy / 40;
  });
}

function createScene() {
  const scene = new BABYLON.Scene(engine);

  // ===== カメラ設定（地面に潜らないよう制限）=====
  const camera = new BABYLON.ArcRotateCamera(
    "camera",
    Math.PI / 2,
    Math.PI / 3,
    12,
    new BABYLON.Vector3(0, 1, 0),
    scene
  );

  camera.attachControl(canvas, true);

  camera.lowerBetaLimit = 0.3;   // 下向きすぎ防止
  camera.upperBetaLimit = 1.4;   // 上向きすぎ防止
  camera.lowerRadiusLimit = 6;   // 近づきすぎ防止
  camera.upperRadiusLimit = 20;  // 離れすぎ防止

  new BABYLON.HemisphericLight(
    "light",
    new BABYLON.Vector3(0, 1, 0),
    scene
  );

  // ===== 島っぽい地形 =====
  const ground = BABYLON.MeshBuilder.CreateDisc(
    "island",
    { radius: 20, tessellation: 64 },
    scene
  );

  ground.rotation.x = Math.PI / 2;

  const groundMat = new BABYLON.StandardMaterial("gmat", scene);
  groundMat.diffuseColor = new BABYLON.Color3(0.2, 0.75, 0.25);
  ground.material = groundMat;

  // 少し盛り上げて“島感”
  ground.position.y = -0.2;

  // 海っぽい外側
  const sea = BABYLON.MeshBuilder.CreateGround(
    "sea",
    { width: 200, height: 200 },
    scene
  );

  const seaMat = new BABYLON.StandardMaterial("smat", scene);
  seaMat.diffuseColor = new BABYLON.Color3(0.2, 0.4, 0.9);
  sea.material = seaMat;

  sea.position.y = -0.4;

  // ===== キャラ読み込み =====
  BABYLON.SceneLoader.ImportMesh(
    "",
    "./",
    "girl character 3d model.glb",
    scene,
    function (meshes, ps, sk, animations) {

      const player = meshes[0];

      // ここが重要！キャラをちゃんと地面の上に
      player.position = new BABYLON.Vector3(0, 0.1, 0);

      camera.lockedTarget = player;

      const speed = 0.12;

      scene.onBeforeRenderObservable.add(() => {
        player.position.x += moveX * speed;
        player.position.z += moveY * speed;

        // 移動方向を向く
        if (moveX !== 0 || moveY !== 0) {
          player.rotation.y = Math.atan2(moveX, moveY);
        }
      });

      window.addEventListener("keydown", (e) => {
        if (e.key === "ArrowUp" || e.key === "w") moveY = 1;
        if (e.key === "ArrowDown" || e.key === "s") moveY = -1;
        if (e.key === "ArrowLeft" || e.key === "a") moveX = -1;
        if (e.key === "ArrowRight" || e.key === "d") moveX = 1;
      });

      window.addEventListener("keyup", () => {
        moveX = 0;
        moveY = 0;
      });

      if (animations.length > 0) {
        animations[0].start(true);
      }
    }
  );

  return scene;
}

setupJoystick();

const scene = createScene();

engine.runRenderLoop(() => {
  scene.render();
});

window.addEventListener("resize", () => {
  engine.resize();
});

</script>

</body>
</html>
