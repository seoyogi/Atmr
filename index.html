<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Yuta Island - AFrame Version</title>
<script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js"></script>
<style>
  body { margin: 0; }
  #viewButton {
    position: absolute;
    right: 20px;
    bottom: 20px;
    padding: 10px;
    font-size: 16px;
    z-index: 10;
  }
</style>
</head>
<body>

<button id="viewButton">視点切替</button>

<a-scene physics="gravity: -9.8">

  <!-- 空 -->
  <a-sky color="#87CEEB"></a-sky>

  <!-- 島 -->
  <a-cylinder position="0 0 0" radius="30" height="0.5" color="#3cb043" static-body></a-cylinder>

  <!-- 砂浜 -->
  <a-cylinder position="0 -0.2 0" radius="40" height="0.4" color="#e8d8a8" static-body></a-cylinder>

  <!-- 海 -->
  <a-cylinder position="0 -0.5 0" radius="100" height="0.5" color="#1e4f9c" static-body></a-cylinder>

  <!-- プレイヤー -->
  <a-entity id="player" position="0 1.2 0" dynamic-body>
    <a-entity id="character" gltf-model="girl character 3d model.glb" scale="1.5 1.5 1.5"></a-entity>
    <a-entity id="camera" camera position="0 3 6" look-controls="enabled:false"></a-entity>
  </a-entity>

</a-scene>

<script>
let mode = 0;
document.getElementById("viewButton").onclick = () => {
  mode = (mode + 1) % 2;
  const cam = document.getElementById("camera");
  cam.setAttribute("position", mode === 0 ? "0 3 6" : "0 3 -6");
};

const player = document.getElementById("player");
const camera = document.getElementById("camera");

let lastX = null;
document.addEventListener("pointerdown", e => { lastX = e.clientX; });
document.addEventListener("pointermove", e => {
  if (lastX !== null) {
    const deltaX = e.clientX - lastX;
    player.object3D.rotation.y -= deltaX * 0.005; // 横回転のみ
    lastX = e.clientX;
  }
});
document.addEventListener("pointerup", () => { lastX = null; });

// キーボード＆仮想スティック風移動
let moveX = 0, moveZ = 0;
document.addEventListener("keydown", e => {
  if (e.key==="w"||e.key==="ArrowUp") moveZ = -0.1;
  if (e.key==="s"||e.key==="ArrowDown") moveZ = 0.1;
  if (e.key==="a"||e.key==="ArrowLeft") moveX = -0.1;
  if (e.key==="d"||e.key==="ArrowRight") moveX = 0.1;
});
document.addEventListener("keyup", e => { moveX=0; moveZ=0; });

// 移動ループ
AFRAME.registerComponent('player-move', {
  tick: function () {
    let obj = player.object3D;
    const forward = new THREE.Vector3(0,0,-1).applyEuler(obj.rotation);
    const right = new THREE.Vector3(1,0,0).applyEuler(obj.rotation);
    const move = forward.multiplyScalar(moveZ).add(right.multiplyScalar(moveX));
    obj.position.add(move);

    // 海に入れない制限
    const dist = Math.sqrt(obj.position.x*obj.position.x + obj.position.z*obj.position.z);
    if (dist > 28) { // 島の半径より大きい場合
      obj.position.x -= move.x;
      obj.position.z -= move.z;
    }

    // 高さ固定（埋もれ防止）
    if (obj.position.y < 1.2) obj.position.y = 1.2;

    // カメラ追従
    camera.object3D.position.x = obj.position.x;
    camera.object3D.position.z = obj.position.z + (mode===0?6:-6);
    camera.object3D.position.y = obj.position.y + 2;
    camera.object3D.lookAt(new THREE.Vector3(obj.position.x, obj.position.y + 1, obj.position.z));
  }
});

player.setAttribute('player-move','');
</script>

</body>
</html>
